import{d as he,u as _e,q as ve,l as Me,i as c,j as Qe,a2 as Se,a3 as we,s as Ie,D as h,k as U,M as G,_ as be,r as w,c as te,o as k,b as i,a as l,w as f,t as _,C as V,f as N,Q as Ce,F as ye}from"./index-Bl_qeBx0.js";import{A as Re}from"./ApiClass-IRHgEt2T.js";import{A as ae}from"./ApiTest-Bc5vSxsT.js";import{Q as D}from"./questionTypes-CS3lcRlq.js";import{T as Ue,a as ke}from"./testGradeQuestionMethod-B_BacNS6.js";import{C as E,S as Ae,O as Fe,M as qe,a as Oe,s as De,b as Ee}from"./vue-virtual-scroller.esm-DmapQBsF.js";import{C as xe,a as Be,b as Le,c as Pe,S as ze}from"./ChooseQuestionModal-29voqkvi.js";import{T as oe}from"./TransferQuestionData-BxcXdBjq.js";import{V as ne}from"./Validator-CWeiTIFe.js";import"./vue-draggable-plus-D0elMdvd.js";/* empty css                                                                 */import"./Input-C6nJoIqP.js";import"./utc-BRbGx3no.js";import"./ApiFolder-C0s9ARp5.js";import"./folderShareMode-BudLQ2R2.js";import"./ApiTestTemplate-BgLb8QbD.js";const He=he({__name:"update",setup(m,{expose:T}){var ee;T();const j={MultipleChoice:Oe,Matching:qe,Ordering:Fe,ShortText:Ae},{t}=_e(),x=ve(),g=Me(),I=c(),b=async()=>{if(!ne.isValidGuid(a.classId)){u.value=!1,g.push({name:"404"});return}const e=await Re.GetById(a.classId);if(!e.data.success){u.value=!1,g.push({name:"404"});return}I.value=e.data.data},A=c(),a=Qe({testId:((ee=x.params.id)==null?void 0:ee.toString())||"",name:"",classId:"",timeLimit:60,startTime:"",endTime:"",gradeAttemptMethod:ke.HIGHEST_SCORE,gradeQuestionMethod:Ue.PARTIAL,isShowCorrectAnswerInReview:!0,isAllowReviewAfterSubmit:!0,numberOfShuffles:2,maxAttempt:2,passingScore:50,createUpdateQuestions:[],deleteQuestionIds:[]}),v={questions:[{validator:(e,n)=>n&&n.length>500?Promise.reject(t("message.maximum_tag.limit_question",{number:500})):Promise.resolve(),trigger:"change"}]},C=c(!1),u=c(!0),p=async()=>{try{if(C.value=!0,!ne.isValidGuid(a.testId)){u.value=!1,g.push({name:"404"});return}const e=await ae.GetById(a.testId,!0);if(!e.data.success){u.value=!1,g.push({name:"404"});return}a.classId=e.data.data.classId,a.testId=e.data.data.testId,a.name=e.data.data.name,a.startTime=e.data.data.startTime,a.endTime=e.data.data.endTime,a.gradeAttemptMethod=e.data.data.gradeAttemptMethod,a.gradeQuestionMethod=e.data.data.gradeQuestionMethod,a.isAllowReviewAfterSubmit=e.data.data.isAllowReviewAfterSubmit,a.isShowCorrectAnswerInReview=e.data.data.isShowCorrectAnswerInReview,a.maxAttempt=e.data.data.maxAttempt,a.numberOfShuffles=e.data.data.numberOfShuffles,a.passingScore=e.data.data.passingScore,a.timeLimit=e.data.data.timeLimit,a.createUpdateQuestions=e.data.data.questions.map(n=>oe.transformResponseToRequest(n))}catch(e){if(e.response.data.success===!1){u.value=!1,g.push({name:"404"});return}}finally{C.value=!1}},F=()=>({id:"new_"+Date.now().toString(),type:"MultipleChoice",questionText:"",questionHTML:"",explainText:"",score:10,multipleChoices:E.defaultMultipleChoices(),matchingPairs:E.defaultMatchingPairs(),orderingItems:E.defaultOrderingItems(),shortAnswer:""}),y=e=>{E.onChangeQuestionType(e)},se=()=>{if(a.createUpdateQuestions.length>=100){U.warning(t("message.limit_question",{number:100}));return}a.createUpdateQuestions=[...a.createUpdateQuestions,F()],h(()=>{var e,n;(n=(e=Q.value)==null?void 0:e.forceUpdate)==null||n.call(e),h(()=>{const r=a.createUpdateQuestions.length;requestAnimationFrame(()=>{var d;(d=Q.value)==null||d.scrollToItem(r)})})})},le=e=>{if(a.createUpdateQuestions.length<=1){U.warning(t("message.minimum_question",{number:1}));return}const n=a.createUpdateQuestions[e].id;!n.startsWith("new_")&&n&&a.deleteQuestionIds.push(n),a.createUpdateQuestions=[...a.createUpdateQuestions.slice(0,e),...a.createUpdateQuestions.slice(e+1)]},ie=async()=>{var O;await((O=A.value)==null?void 0:O.validate());let e=!1,n=t("message.invalid_question"),r=new Set;if(a.name.trim().length>100||a.name.trim().length===0){e=!0,n=t("message.invalid_title"),U.error(n),B();return}[a.createUpdateQuestions.filter(o=>{const s=o.questionText.replace(/^<p>/,"").replace(/<\/p>$/,"").trim();return s.length===0||s.length>=5e3}),a.createUpdateQuestions.filter(o=>(o.explainText?o.explainText.replace(/^<p>/,"").replace(/<\/p>$/,"").trim():"").length>=5e3),a.createUpdateQuestions.filter(o=>o.type===D.MULTIPLE_CHOICE&&(o.multipleChoices.some(s=>s.text.trim().length===0||s.text.trim().length>1e3)||o.multipleChoices.filter(s=>s.isAnswer).length===0||o.multipleChoices.length<2)),a.createUpdateQuestions.filter(o=>o.type===D.MATCHING&&(o.matchingPairs.some(s=>s.leftItem.trim().length===0||s.leftItem.trim().length>1e3)||o.matchingPairs.some(s=>s.rightItem.trim().length===0||s.rightItem.trim().length>1e3)||o.matchingPairs.length<2)),a.createUpdateQuestions.filter(o=>o.type===D.ORDERING&&(o.orderingItems.some(s=>s.text.trim().length===0||s.text.trim().length>1e3)||o.orderingItems.length<2)),a.createUpdateQuestions.filter(o=>o.type===D.SHORT_TEXT&&(o.shortAnswer.trim().length===0||o.shortAnswer.trim().length>1e3))].forEach(o=>{o.length>0&&(e=!0,o.forEach(s=>r.add(s)))});let S=Array.from(r).map(o=>a.createUpdateQuestions.indexOf(o)+1);e?G.error({title:t("update_test.modal.invalid.title"),content:t("update_test.modal.invalid.content")+S.sort().join(", "),okText:t("sidebar.buttons.ok"),cancelText:t("sidebar.buttons.cancel")}):W()},W=()=>{G.confirm({title:t("update_test.modal.valid.title"),content:t("update_test.modal.valid.content"),okText:t("sidebar.buttons.ok"),cancelText:t("sidebar.buttons.cancel"),centered:!0,onOk:async()=>{(await ae.Update({...a,createUpdateQuestions:a.createUpdateQuestions.map(n=>({questionId:n.id.startsWith("new_")?null:n.id,...n}))})).data.success&&(u.value=!1,g.push({name:"User_Class_Exam",params:{id:a.classId}}),U.success("Updated successfully!"))}})},X=c(null),B=()=>{var e;(e=X.value)==null||e.openTestSettingModal()},R=c(null),L=()=>{var e;(e=R.value)==null||e.openModal()},re=()=>{var e;M.value=null,(e=R.value)==null||e.closeModal(),z()},de=e=>{var n;M.value=e,(n=R.value)==null||n.closeModal(),P()},M=c(null),Y=c(""),J=c(null),P=()=>{var e;(e=J.value)==null||e.openModal()},ce=()=>{M.value=null,L()},q=c(null),z=()=>{var e;(e=q.value)==null||e.openModal()},ue=()=>{var e;M.value=null,(e=q.value)==null||e.closeModal(),L()},me=async(e,n)=>{var r;Y.value=e,(r=q.value)==null||r.closeModal(),M.value=n,await h(),Z()},K=c(null),Z=()=>{var e;(e=K.value)==null||e.openModal()},pe=async e=>{M.value=e,await h(),P()},fe=()=>{z()},Te=e=>{var r;const n=e.map(d=>oe.transformResponseToRequest(d)).map((d,S)=>({...d,id:`new_${a.createUpdateQuestions.length+S}`}));(r=R.value)==null||r.closeModal(),a.createUpdateQuestions=[...a.createUpdateQuestions,...n],h(()=>{var d,S;(S=(d=Q.value)==null?void 0:d.forceUpdate)==null||S.call(d),h(()=>{const O=a.createUpdateQuestions.length;requestAnimationFrame(()=>{var o;(o=Q.value)==null||o.scrollToItem(O)})})}),U.success(`${t("message.imported_question",{number:e.length})}`)};Se((e,n,r)=>{if(!u.value){r();return}G.confirm({title:t("create_QS.modal.leave.title"),content:t("create_QS.modal.leave.content"),okText:t("sidebar.buttons.ok"),cancelText:t("sidebar.buttons.cancel"),onOk:()=>{r()},onCancel:()=>r(!1)})});function H(e){e.preventDefault(),e.returnValue=""}we(()=>{window.removeEventListener("beforeunload",H)});const Q=c(null),ge=()=>{h(()=>{var e,n;(n=(e=Q.value)==null?void 0:e.forceUpdate)==null||n.call(e)})};Ie(async()=>{await p(),await b(),window.addEventListener("beforeunload",H),await h(),B()});const $={componentMap:j,t,route:x,router:g,classData:I,getClassData:b,formRef:A,formState:a,rules:v,loading:C,isDataValid:u,getData:p,createQuestionTemplate:F,onHandleChangeQuestionType:y,onAddQuestion:se,onRemoveQuestion:le,onFinish:ie,showModalConfirmation:W,settingModalRef:X,openSettingModal:B,folderModalRef:R,openFolderModal:L,onSwitchToTestTemplate:re,onOpenFolder:de,chosenFolder:M,chosenTestTemplateId:Y,folderTestTemplateModalRef:J,openFolderTestTemplateModal:P,onBackToFolderModal:ce,testTemplateModalRef:q,openTestTemplateModal:z,onSwitchToFolder:ue,onOpenTestTemplate:me,questionModalRef:K,openQuestionModal:Z,onBackToFolderTestTemplate:pe,onBackToTestTemplate:fe,onModalImport:Te,handleBeforeUnload:H,scrollerRef:Q,handleScroll:ge,SettingTestModal:ze,ChooseFolderModal:Pe,ChooseFolderTestTemplateModal:Le,ChooseTestTemplateModal:Be,ChooseQuestionModal:xe,get DynamicScroller(){return Ee},get DynamicScrollerItem(){return De}};return Object.defineProperty($,"__isScriptSetup",{enumerable:!1,value:!0}),$}}),Ge={class:"page-container"},Ve={class:"title-container"},Ne={class:"content"},je={class:"content-item"},We={class:"content-item-title"},Xe={class:"content-item-buttons"},Ye={class:"import-button"},Je={key:0};function Ke(m,T,j,t,x,g){var u;const I=w("RouterLink"),b=w("a-col"),A=w("a-row"),a=w("a-button"),v=w("a-skeleton"),C=w("a-form");return k(),te(ye,null,[i("div",Ge,[i("div",Ve,[l(A,{class:"w-100 d-flex align-items-center"},{default:f(()=>[l(b,{span:1},{default:f(()=>[l(I,{to:{name:""},onClick:t.openSettingModal},{default:f(()=>T[0]||(T[0]=[i("i",{class:"bx bx-chevron-left navigator-back-button"},null,-1)])),_:1,__:[0]})]),_:1}),l(b,{class:"main-title",span:23},{default:f(()=>[i("span",null,_(m.$t("update_test.title",{test_name:t.formState.name})),1),T[1]||(T[1]=i("br",null,null,-1)),i("span",null,_(m.$t("update_test.sub_title")),1)]),_:1,__:[1]})]),_:1})]),i("div",Ne,[l(C,{layout:"vertical",model:t.formState,rules:t.rules,ref:"formRef"},{default:f(()=>[i("div",je,[i("div",We,[i("div",null,[i("span",null,_(m.$t("assign_test.test_question.title")),1),i("span",null,_(m.$t("assign_test.test_question.sub_title")),1)]),i("div",Xe,[l(I,{class:"import-button",to:{name:""},onClick:t.openFolderModal},{default:f(()=>[N(_(m.$t("assign_test.buttons.choose_from_folder")),1)]),_:1}),i("div",Ye,_(m.$t("create_QS.quiz.total",{number:t.formState.createUpdateQuestions.length.toString().padStart(3,"0")})),1),l(a,{type:"primary",class:"main-color-btn",size:"large",onClick:t.onFinish},{default:f(()=>[N(_(m.$t("assign_test.buttons.next")),1)]),_:1})])]),t.loading?(k(),te("div",Je,[l(v,{loading:t.loading,active:""},null,8,["loading"]),l(v,{loading:t.loading,active:""},null,8,["loading"]),l(v,{loading:t.loading,active:""},null,8,["loading"]),l(v,{loading:t.loading,active:""},null,8,["loading"]),l(v,{loading:t.loading,active:""},null,8,["loading"])])):(k(),V(t.DynamicScroller,{key:1,ref:"scrollerRef",class:"scroller","key-field":"id",items:t.formState.createUpdateQuestions,"min-item-size":650,buffer:800,prerender:10,onScroll:t.handleScroll},{default:f(({item:p,index:F})=>[(k(),V(t.DynamicScrollerItem,{item:p,key:p.id},{default:f(()=>[(k(),V(Ce(t.componentMap[p.type]),{question:p,index:t.formState.createUpdateQuestions.findIndex(y=>y.id===p.id)+1,displayScore:!0,onDeleteQuestion:y=>t.onRemoveQuestion(F),onChangeQuestionType:y=>t.onHandleChangeQuestionType(p)},null,40,["question","index","onDeleteQuestion","onChangeQuestionType"]))]),_:2},1032,["item"]))]),_:1},8,["items"])),i("div",{class:"add-question-btn",onClick:t.onAddQuestion},[T[2]||(T[2]=i("i",{class:"bx bx-plus"},null,-1)),N(" "+_(m.$t("create_QS.buttons.add_question")),1)])])]),_:1},8,["model"])])]),l(t.SettingTestModal,{ref:"settingModalRef","form-ref":t.formRef,"class-name":(u=t.classData)==null?void 0:u.name,"form-state":t.formState},null,8,["form-ref","class-name","form-state"]),l(t.ChooseFolderModal,{ref:"folderModalRef",onSwitchToTestTemplate:t.onSwitchToTestTemplate,onOpenFolder:t.onOpenFolder},null,512),l(t.ChooseFolderTestTemplateModal,{ref:"folderTestTemplateModalRef",folder:t.chosenFolder,onBackToFolderModal:t.onBackToFolderModal,onOpenTestTemplate:t.onOpenTestTemplate},null,8,["folder"]),l(t.ChooseTestTemplateModal,{ref:"testTemplateModalRef",onSwitchToFolder:t.onSwitchToFolder,onOpenTestTemplate:t.onOpenTestTemplate},null,512),l(t.ChooseQuestionModal,{ref:"questionModalRef","test-template-id":t.chosenTestTemplateId,folder:t.chosenFolder,onBackToFolderTestTemplateModal:t.onBackToFolderTestTemplate,onBackToTestTemplateModal:t.onBackToTestTemplate,onImport:t.onModalImport},null,8,["test-template-id","folder"])],64)}const ft=be(He,[["render",Ke],["__scopeId","data-v-c9dbf500"],["__file","/home/runner/work/AIQuizzizz-Frontend/AIQuizzizz-Frontend/src/views/user/test/update.vue"]]);export{ft as default};
